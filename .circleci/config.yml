aliases:
  - &restore-yarn-cache
      name: Restore Yarn package cache
      keys:
        - yarn-packages-{{ .Branch }}-{{ checksum "yarn.lock" }}
        - yarn-packages-{{ .Branch }}
        - yarn-packages-master
        - yarn-packages-

  - &save-yarn-cache
      name: Save Yarn package cache
      key: yarn-packages-{{ .Branch }}-{{ checksum "yarn.lock" }}
      paths:
        - node_modules

  - &install-yarn-dependencies
      name: Install dependencies
      command: yarn install && yarn build && yarn bootstrap

defaults: &defaults
  working_directory: ~/warriorjs
  docker:
    - image: circleci/node:8

version: 2
jobs:
  build:
    <<: *defaults

    branches:
      ignore:
        - gh-pages

    steps:
      - checkout

      - restore_cache: *restore-yarn-cache

      - run: *install-yarn-dependencies

      - save_cache: *save-yarn-cache

      - run:
          name: Run tests
          command: yarn test:coverage

      - run:
          name: Report coverage
          command: bash <(curl -s https://codecov.io/bash)

      - run:
          name: Build website
          command: cd website && yarn build
